import requests

def get_metar(icao_code, api_key=None):
    """
    Fetches METAR data for the given ICAO code.
    If no api_key is provided, returns mock data.
    Returns: dict with keys: 'icao', 'temp_c', 'wind_kts', 'visibility_m'
    """
    if api_key is None:
        # Mock data
        return {
            "icao": icao_code.upper(),
            "temp_c": 22.5,
            "wind_kts": 12,
            "visibility_m": 8000
        }
    # Example real call (replace with real endpoint)
    url = f"https://api.metar-service.org/metar/{icao_code.upper()}?token={api_key}"
    resp = requests.get(url)
    resp.raise_for_status()
    data = resp.json()
    # Parse and map to our structure
    return {
        "icao": icao_code.upper(),
        "temp_c": data.get("temperature_c"),
        "wind_kts": data.get("wind_speed_kt"),
        "visibility_m": data.get("visibility_statute_mi", 0) * 1609.34
    }
